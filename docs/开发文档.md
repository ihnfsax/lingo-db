# 编译说明

## 编译 LLVM

```bash
cd llvm-project
cmake -S llvm -B build -G Ninja \
   -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lldb;mlir;lld" \
   -DCMAKE_BUILD_TYPE=Release \
   -DLLVM_BUILD_EXAMPLES=ON \
   -DLLVM_TARGETS_TO_BUILD="Native;NVPTX;AMDGPU" \
   -DLLVM_CCACHE_BUILD=ON \
   -DLLVM_INSTALL_UTILS=ON \
   -DLLVM_ENABLE_ASSERTIONS=ON \
   -DCMAKE_C_COMPILER=clang \
   -DCMAKE_CXX_COMPILER=clang++ \
   -DLLVM_USE_LINKER=lld \
   -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
cmake --build ./build
```

## 编译 LINGO-DB

安装依赖：

- arrow: https://arrow.apache.org/install/
- opentbb: https://github.com/oneapi-src/oneTBB/releases/tag/v2021.11.0 解压到 oneapi-tbb 目录下。

找不到 opentbb 时，可以在 CMakeLists.txt 中添加：

```cmake
set(TBB_LIB_PATH "${CMAKE_CURRENT_LIST_DIR}/oneapi-tbb/lib/intel64/gcc4.8")
set(TBB_INCLUDE_DIR "${CMAKE_CURRENT_LIST_DIR}/oneapi-tbb/include")
```

编译：

```bash
cmake -S . -B build -G Ninja \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
    -DCMAKE_BUILD_TYPE=Debug
cmake --build ./build
```

如果找不到 LLVM，请在 CMakeLists.txt 中添加：

```cmake
list(APPEND CMAKE_PREFIX_PATH "${CMAKE_CURRENT_LIST_DIR}/llvm-project/build")
```

## 打印 MLIR

先把 Lingo-DB 所有可执行文件添加到 PATH 中：

```bash
export PATH="${PATH:+${PATH}:}/home/ihnfsa/develop/lingo-db/build"
```

这些可执行文件在执行时有几种 Mode 可以选择：

```c++
enum class ExecutionMode {
   SPEED = 0, //Aim for maximum speed (no verification of generated MLIR
   DEFAULT = 1, //Execute without introducing extra steps for debugging/profiling, but verify generated MLIR
   PERF = 2, //Profiling
   DEBUGGING = 3, //Make generated code debuggable
   CHEAP = 4, // compile as cheap (compile time) as possible
   EXTREME_CHEAP = 5, // compile as cheap (compile time) as possible, don't verify MLIR module
   C = 6,
};
```

可以通过设置 `LINGODB_EXECUTION_MODE` 环境变量来选择 Mode，例如：

```bash
LINGODB_EXECUTION_MODE=DEBUGGING run-sql resources/sql/uni/1.sql resources/data/uni
```

上述命令将在当前目录生成各阶段的 MLIR 文件。

可以使用 `mlir-db-opt` 打印 MLIR 的通用格式：

```bash
mlir-db-opt -mlir-print-op-generic snapshot-0.mlir
```

写了一个脚步 `gen-generic-op.sh` 来自动化以上步骤：

```bash
./gen-generic-op.sh 1.sql
```

其中，`1.sql` 放在 `resources/sql/temp` 目录下，默认使用 `resources/data/uni` 作为数据源，schema 可以查看 `resources/sql/uni/initialize.sql`。